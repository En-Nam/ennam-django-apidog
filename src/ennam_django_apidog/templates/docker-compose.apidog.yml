version: '3.8'

# APIDOG Docker Compose configuration
# Generated by: pip install ennam-django-apidog
# Usage: docker-compose -f docker-compose.apidog.yml up -d

services:
  # APIDOG Mock Server for local development
  apidog-mock:
    image: apidog/mock-server:latest
    container_name: apidog-mock
    ports:
      - "4010:4010"  # Mock server port
    environment:
      - PROJECT_ID=${APIDOG_PROJECT_ID}
      - API_TOKEN=${APIDOG_TOKEN}
      - MOCK_PORT=4010
      - LOG_LEVEL=info
      - AUTO_RELOAD=true
      - CORS_ENABLED=true
      - CORS_ORIGINS=http://localhost:3000,http://localhost:8080
    volumes:
      - ./apidog:/app/schemas:ro
      - ./apidog/environments.json:/app/config/environments.json:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4010/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # APIDOG CLI Runner for automated testing
  apidog-runner:
    image: apidog/cli:latest
    container_name: apidog-runner
    environment:
      - PROJECT_ID=${APIDOG_PROJECT_ID}
      - API_TOKEN=${APIDOG_TOKEN}
      - ENVIRONMENT=local
      - BASE_URL=http://web:8000  # Change this to your Django service name
    volumes:
      - ./apidog/test_collections.json:/app/collections/tests.json:ro
      - ./test-results:/app/results
    profiles:
      - testing
    command: >
      sh -c "
        echo 'Waiting for Django service...' &&
        sleep 10 &&
        apidog run \
          --collection /app/collections/tests.json \
          --environment local \
          --reporters cli,html,junit \
          --reporter-html-export /app/results/report.html \
          --reporter-junit-export /app/results/results.xml
      "
